<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Centrum nieruchomości</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; }
    :root{
      --ring: 59 130 246;
      --shadow-soft: 0 24px 80px -40px rgba(2,6,23,.35);
      --shadow-card: 0 18px 60px -40px rgba(2,6,23,.30);
    }
    .focus-ring:focus-visible {
      outline: none;
      box-shadow: 0 0 0 4px rgba(var(--ring), .22);
      border-color: rgba(var(--ring), .6);
    }
    .glass {
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(226,232,240,.75);
      backdrop-filter: blur(16px);
    }
    .soft-gradient {
      background:
        radial-gradient(1100px 600px at 20% 10%, rgba(59,130,246,.20), transparent 60%),
        radial-gradient(900px 520px at 85% 0%, rgba(37,99,235,.16), transparent 55%),
        radial-gradient(900px 520px at 50% 100%, rgba(99,102,241,.10), transparent 55%),
        linear-gradient(to bottom, rgba(239,246,255,.92), rgba(255,255,255,1), rgba(239,246,255,.92));
    }
  </style>
</head>

<body class="min-h-screen soft-gradient text-zinc-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    const LS_KEY = "admin_listings_v1";

    const cn = (...c) => c.filter(Boolean).join(" ");
    const currency = (n) => new Intl.NumberFormat("pl-PL", { style: "currency", currency: "PLN", maximumFractionDigits: 0 }).format(Number(n || 0));
    const uid = () => "a_" + Math.random().toString(36).slice(2) + Date.now().toString(36);

    function readListings(){
      try {
        const raw = localStorage.getItem(LS_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch { return []; }
    }
    function writeListings(items){
      try { localStorage.setItem(LS_KEY, JSON.stringify(items)); } catch {}
    }

    const Button = ({ variant="default", className, ...props }) => {
      const variants = {
        default: "bg-blue-600 text-white hover:bg-blue-700",
        outline: "border border-zinc-200 bg-white/60 hover:bg-white",
        destructive: "bg-red-500 text-white hover:bg-red-600",
        secondary: "bg-blue-100 text-blue-900 hover:bg-blue-200",
        ghost: "hover:bg-white/60"
      };
      return (
        <button
          className={cn(
            "h-10 px-4 rounded-2xl text-sm font-semibold transition-colors focus-ring active:translate-y-[1px]",
            variants[variant],
            className
          )}
          {...props}
        />
      );
    };

    const Input = (props) => (
      <input
        {...props}
        className={cn(
          "h-10 w-full rounded-2xl border border-zinc-200 bg-white/70 px-3 text-sm focus-ring",
          props.className
        )}
      />
    );

    const Textarea = (props) => (
      <textarea
        {...props}
        className={cn(
          "min-h-[110px] w-full rounded-2xl border border-zinc-200 bg-white/70 px-3 py-2 text-sm focus-ring",
          props.className
        )}
      />
    );

    function App(){
      const [items, setItems] = useState(() => readListings());
      const [open, setOpen] = useState(false);
      const [editing, setEditing] = useState(null);
      const [query, setQuery] = useState("");

      useEffect(() => writeListings(items), [items]);

      const filtered = useMemo(() => {
        const q = query.trim().toLowerCase();
        if (!q) return items;
        return items.filter(x =>
          (x.title || "").toLowerCase().includes(q) ||
          (x.city || "").toLowerCase().includes(q) ||
          (x.type || "").toLowerCase().includes(q)
        );
      }, [items, query]);

      const onCreate = () => { setEditing(null); setOpen(true); };
      const onEdit = (it) => { setEditing(it); setOpen(true); };
      const onDelete = (id) => {
        if (!confirm("Na pewno usunąć ogłoszenie?")) return;
        setItems(prev => prev.filter(x => x.id !== id));
      };

      return (
        <div className="min-h-screen">
          <header className="sticky top-0 z-50 glass border-b shadow-[0_18px_60px_-35px_rgba(2,6,23,.45)]">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-2xl bg-blue-600 text-white flex items-center justify-center font-bold">A</div>
                <div>
                  <div className="font-semibold tracking-tight">Panel admina</div>
                  <div className="text-xs text-zinc-600">Centrum nieruchomości</div>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <a href="./index.html" className="hidden sm:block">
                  <Button variant="outline">Otwórz stronę</Button>
                </a>
                <Button onClick={onCreate}>+ Dodaj ogłoszenie</Button>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 py-8">
            <div className="grid md:grid-cols-12 gap-3">
              <div className="md:col-span-6">
                <Input value={query} onChange={(e)=>setQuery(e.target.value)} placeholder="Szukaj po tytule / mieście / typie..." />
              </div>
              <div className="md:col-span-6 flex items-center justify-end gap-2">
                <Button variant="secondary" onClick={() => {
                  const json = localStorage.getItem(LS_KEY) || "[]";
                  navigator.clipboard?.writeText(json);
                  alert("Skopiowano JSON z ogłoszeniami do schowka.");
                }}>
                  Kopiuj JSON
                </Button>
                <Button variant="outline" onClick={() => {
                  if (!confirm("To usunie wszystkie ogłoszenia z localStorage. Kontynuować?")) return;
                  setItems([]);
                }}>
                  Wyczyść wszystko
                </Button>
              </div>
            </div>

            <div className="mt-6 grid gap-4 md:grid-cols-3">
              {filtered.map((it) => (
                <div key={it.id} className="rounded-3xl glass border shadow-[var(--shadow-soft)] overflow-hidden">
                  <div className="h-48 bg-black/5">
                    {it.images?.[0] ? (
                      <img src={it.images[0]} alt={it.title} className="w-full h-full object-cover" />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-zinc-500">Brak zdjęcia</div>
                    )}
                  </div>
                  <div className="p-4">
                    <div className="flex items-start justify-between gap-2">
                      <div>
                        <div className="font-semibold">{it.title || "Oferta"}</div>
                        <div className="text-sm text-zinc-600">{it.city} • {it.type}</div>
                      </div>
                      <div className="text-right">
                        <div className="font-semibold">{currency(it.price)}</div>
                        <div className="text-xs text-zinc-500">{it.area} m² • {it.rooms} pok.</div>
                      </div>
                    </div>

                    <div className="mt-3 flex flex-wrap gap-2 text-xs">
                      {it.featured && <span className="px-2 py-1 rounded-full bg-blue-600 text-white">Polecane</span>}
                      {it.market && <span className="px-2 py-1 rounded-full bg-white/70 border">{it.market}</span>}
                      {it.finish && <span className="px-2 py-1 rounded-full bg-white/70 border">{it.finish}</span>}
                    </div>

                    <div className="mt-4 flex gap-2">
                      <Button className="w-1/2" variant="outline" onClick={() => onEdit(it)}>Edytuj</Button>
                      <Button className="w-1/2" variant="destructive" onClick={() => onDelete(it.id)}>Usuń</Button>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            {!filtered.length && (
              <div className="mt-10 rounded-3xl glass border p-10 text-center shadow-[var(--shadow-soft)]">
                <div className="text-xl font-semibold">Brak ogłoszeń</div>
                <p className="mt-2 text-zinc-600">Kliknij „Dodaj ogłoszenie”, aby dodać pierwszą ofertę.</p>
                <Button className="mt-6" onClick={onCreate}>Dodaj ogłoszenie</Button>
              </div>
            )}
          </main>

          {open && (
            <Modal onClose={() => setOpen(false)}>
              <ListingForm
                initial={editing}
                onCancel={() => setOpen(false)}
                onSave={(payload) => {
                  if (editing) {
                    setItems(prev => prev.map(x => x.id === editing.id ? payload : x));
                  } else {
                    setItems(prev => [payload, ...prev]);
                  }
                  setOpen(false);
                }}
              />
            </Modal>
          )}
        </div>
      );
    }

    function Modal({ children, onClose }){
      return (
        <div className="fixed inset-0 z-[100] bg-black/55 backdrop-blur-sm" onClick={onClose}>
          <div onClick={(e)=>e.stopPropagation()} className="max-w-4xl w-[95vw] max-h-[90vh] overflow-auto mx-auto mt-10 glass border rounded-3xl shadow-[var(--shadow-soft)] p-6">
            <div className="flex items-center justify-between gap-3">
              <div className="text-lg font-semibold">Ogłoszenie</div>
              <Button variant="outline" onClick={onClose}>Zamknij</Button>
            </div>
            <div className="mt-4">{children}</div>
          </div>
        </div>
      );
    }

    function ListingForm({ initial, onSave, onCancel }){
      const [title, setTitle] = useState(initial?.title || "");
      const [price, setPrice] = useState(initial?.price ?? 300000);
      const [area, setArea] = useState(initial?.area ?? 50);
      const [rooms, setRooms] = useState(initial?.rooms ?? 2);
      const [city, setCity] = useState(initial?.city || "");
      const [type, setType] = useState(initial?.type || "Mieszkanie");
      const [description, setDescription] = useState(initial?.description || "");

      // opcjonalne
      const [rent, setRent] = useState(initial?.rent || "");
      const [market, setMarket] = useState(initial?.market || "");
      const [finish, setFinish] = useState(initial?.finish || "");
      const [floor, setFloor] = useState(initial?.floor ?? "");
      const [heating, setHeating] = useState(initial?.heating || "");
      const [ownership, setOwnership] = useState(initial?.ownership || "");
      const [featured, setFeatured] = useState(!!initial?.featured);

      const [images, setImages] = useState(Array.isArray(initial?.images) ? initial.images : []);
      const [imgError, setImgError] = useState("");

      const allValid =
        (title.trim().length >= 3) &&
        (city.trim().length >= 2) &&
        (Number(price) > 0) &&
        (Number(area) > 0) &&
        (Number(rooms) > 0) &&
        (description.trim().length >= 10);

      const handleFiles = async (fileList) => {
        setImgError("");
        const list = Array.from(fileList || []);
        if (!list.length) return;

        const remaining = 15 - images.length;
        if (remaining <= 0) { setImgError("Masz już 15 zdjęć."); return; }

        const take = list.slice(0, remaining);

        const toDataUrl = (file) => new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(String(reader.result));
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        try {
          const converted = [];
          for (const f of take) converted.push(await toDataUrl(f));
          setImages(prev => [...prev, ...converted]);
        } catch {
          setImgError("Nie udało się wczytać zdjęć.");
        }
      };

      const removeImage = (idx) => setImages(prev => prev.filter((_, i) => i !== idx));

      const submit = (e) => {
        e.preventDefault();
        if (!allValid) return;

        const now = Date.now();

        const payload = {
          id: initial?.id || uid(),
          createdAt: initial?.createdAt || now,
          updatedAt: now,

          title: title.trim(),
          price: Number(price),
          area: Number(area),
          rooms: Number(rooms),
          city: city.trim(),
          type: type.trim(),
          description: description.trim(),

          // opcjonalne
          rent: rent ? String(rent).trim() : "",
          market: market ? String(market).trim() : "",
          finish: finish ? String(finish).trim() : "",
          floor: floor === "" ? null : (isNaN(Number(floor)) ? String(floor).trim() : Number(floor)),
          heating: heating ? String(heating).trim() : "",
          ownership: ownership ? String(ownership).trim() : "",
          featured,

          images: images.slice(0, 15),
          image: (images[0] || ""),
        };

        onSave(payload);
      };

      return (
        <form onSubmit={submit} className="grid md:grid-cols-2 gap-4">
          <div className="md:col-span-2 rounded-3xl border bg-white/60 p-4">
            <div className="text-sm font-semibold mb-2">Zdjęcia (max 15) – pierwsze to okładka</div>
            <div className="flex items-center justify-between gap-3">
              <label className="inline-flex items-center gap-2 cursor-pointer">
                <input type="file" accept="image/*" multiple className="hidden" onChange={(e)=>handleFiles(e.target.files)} />
                <Button type="button" variant="secondary">Dodaj zdjęcia</Button>
              </label>
              <div className="text-xs text-zinc-500">{images.length}/15</div>
            </div>

            {imgError && <div className="mt-2 text-sm text-red-600">{imgError}</div>}

            {!!images.length && (
              <div className="mt-4 grid grid-cols-2 md:grid-cols-6 gap-3">
                {images.map((src, i) => (
                  <div key={i} className="relative">
                    <img src={src} alt={"img"+i} className="h-24 w-full object-cover rounded-2xl border" />
                    <button
                      type="button"
                      onClick={() => removeImage(i)}
                      className="absolute top-2 right-2 px-2 py-1 rounded-xl bg-white/90 border text-xs hover:bg-white focus-ring"
                    >
                      usuń
                    </button>
                    {i === 0 && <div className="absolute left-2 bottom-2 text-[10px] px-2 py-1 rounded-full bg-black/70 text-white">Okładka</div>}
                  </div>
                ))}
              </div>
            )}
          </div>

          <div>
            <label className="text-xs text-zinc-500">Tytuł</label>
            <Input value={title} onChange={(e)=>setTitle(e.target.value)} placeholder="Np. 3 pokoje w centrum" />
          </div>

          <div>
            <label className="text-xs text-zinc-500">Typ</label>
            <select className="h-10 w-full rounded-2xl border border-zinc-200 bg-white/70 px-3 text-sm focus-ring"
              value={type} onChange={(e)=>setType(e.target.value)}>
              <option>Mieszkanie</option>
              <option>Dom</option>
              <option>Działka</option>
              <option>Lokal</option>
            </select>
          </div>

          <div>
            <label className="text-xs text-zinc-500">Lokalizacja (miasto)</label>
            <Input value={city} onChange={(e)=>setCity(e.target.value)} placeholder="Np. Słupsk" />
          </div>

          <div className="grid grid-cols-3 gap-2">
            <div>
              <label className="text-xs text-zinc-500">Cena</label>
              <Input type="number" value={price} onChange={(e)=>setPrice(e.target.value)} />
            </div>
            <div>
              <label className="text-xs text-zinc-500">Metraż</label>
              <Input type="number" value={area} onChange={(e)=>setArea(e.target.value)} />
            </div>
            <div>
              <label className="text-xs text-zinc-500">Pokoje</label>
              <Input type="number" value={rooms} onChange={(e)=>setRooms(e.target.value)} />
            </div>
          </div>

          <div className="md:col-span-2">
            <label className="text-xs text-zinc-500">Opis</label>
            <Textarea value={description} onChange={(e)=>setDescription(e.target.value)} placeholder="Opis oferty (min. 10 znaków)..." />
          </div>

          <div className="md:col-span-2 rounded-3xl border bg-white/60 p-4">
            <div className="flex items-center justify-between gap-3">
              <div>
                <div className="text-sm font-semibold">Opcjonalne pola</div>
                <div className="text-xs text-zinc-500">Możesz zostawić puste.</div>
              </div>
              <label className="flex items-center gap-2 text-sm text-zinc-700 select-none">
                <input type="checkbox" checked={featured} onChange={(e)=>setFeatured(e.target.checked)} />
                Polecane (na stronę główną)
              </label>
            </div>

            <div className="mt-3 grid md:grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-zinc-500">Czynsz</label>
                <Input value={rent} onChange={(e)=>setRent(e.target.value)} placeholder="Np. 650 zł" />
              </div>
              <div>
                <label className="text-xs text-zinc-500">Rynek</label>
                <Input value={market} onChange={(e)=>setMarket(e.target.value)} placeholder="Np. wtórny / pierwotny" />
              </div>
              <div>
                <label className="text-xs text-zinc-500">Stan wykończenia</label>
                <Input value={finish} onChange={(e)=>setFinish(e.target.value)} placeholder="Np. do zamieszkania" />
              </div>
              <div>
                <label className="text-xs text-zinc-500">Piętro</label>
                <Input value={floor} onChange={(e)=>setFloor(e.target.value)} placeholder="Np. 3" />
              </div>
              <div>
                <label className="text-xs text-zinc-500">Ogrzewanie</label>
                <Input value={heating} onChange={(e)=>setHeating(e.target.value)} placeholder="Np. miejskie" />
              </div>
              <div>
                <label className="text-xs text-zinc-500">Forma własności</label>
                <Input value={ownership} onChange={(e)=>setOwnership(e.target.value)} placeholder="Np. pełna własność" />
              </div>
            </div>
          </div>

          <div className="md:col-span-2 flex items-center justify-end gap-2">
            <Button type="button" variant="outline" onClick={onCancel}>Anuluj</Button>
            <Button type="submit" disabled={!allValid}>
              {initial ? "Zapisz zmiany" : "Dodaj ogłoszenie"}
            </Button>
          </div>

          {!allValid && (
            <div className="md:col-span-2 text-xs text-zinc-500">
              Wymagane: tytuł (min. 3), miasto, cena, metraż, pokoje, opis (min. 10).
            </div>
          )}
        </form>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
